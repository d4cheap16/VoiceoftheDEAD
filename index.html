<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- Favicon -->
    <link rel="icon" href="https://d4cheap16.github.io/VoiceoftheDEAD/zombie.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 社群分享標籤 (Open Graph) 與 搜尋引擎優化 (SEO) -->
    <title>Voice of the Dead</title>
    <meta name="description" content="Want to Survive? Speak!">
    <meta property="og:title" content="Speak your way out. - Voice of the Dead">
    <meta property="og:description" content="面對恐懼，大聲讀出咒語以驅除喪屍。這是一場結合聲音辨識與節奏的生存挑戰。">
    <meta property="og:image" content="https://d4cheap16.github.io/VoiceoftheDEAD/opentag.png">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --horror-red: #8b0000;
            --horror-green: #00ff00;
            --horror-yellow: #ffff00;
        }

        body {
            background-color: #000;
            color: #ccc;
            font-family: 'Press Start 2P', 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100dvh; overflow: hidden;
            user-select: none; touch-action: manipulation;
        }

        /* CRT 掃描線特效 */
        .crt::before {
            content: " ";
            display: block; position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100; background-size: 100% 3px, 2px 100%;
            pointer-events: none;
        }

        /* 畫面故障特效 */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-5px, 5px); filter: hue-rotate(90deg); }
            40% { transform: translate(5px, -5px); }
            60% { transform: translate(-5px, 0); }
            100% { transform: translate(0); }
        }
        .glitch-active { animation: glitch 0.2s infinite; }

        .game-wrapper {
            position: relative;
            width: 100%; max-width: 500px; height: 100dvh;
            background: #000; display: flex; flex-direction: column;
            overflow: hidden; border-left: 2px solid #222; border-right: 2px solid #222;
        }

        .canvas-container {
            width: 100%; height: 67%;
            position: relative; border-bottom: 2px solid var(--horror-red);
            overflow: hidden; background: #050505;
        }

        #game-canvas { image-rendering: pixelated; width: 100%; height: 100%; }

        .ui-panel {
            height: 33%; width: 100%; background: #050505;
            padding: 12px 15px; display: grid; grid-template-rows: auto 1fr auto; 
            gap: 10px; z-index: 50; box-sizing: border-box;
        }

        .btn {
            background: #0a0a0a; border: 1px solid #444; color: #ccc;
            padding: 10px; cursor: pointer; font-size: 8px;
            font-family: 'Press Start 2P', cursive;
            transition: 0.1s;
        }
        .btn:active { background: #333; color: #fff; transform: scale(0.95); }

        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; text-align: center; padding: 20px;
        }

        .active-diff { border-color: #fff !important; background: #222 !important; color: #fff !important; }
        
        #boss-ui {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            pointer-events: none; transition: opacity 0.5s; opacity: 0;
        }
        .boss-word-active { color: #0f0; text-shadow: 0 0 10px #0f0; transform: scale(1.2); }

        .admin-table-container {
            width: 100%; max-height: 300px; overflow-y: auto; font-size: 8px;
            border: 1px solid #333; margin-top: 10px; background: #050505;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .flicker { animation: flicker 0.2s infinite; }
    </style>
</head>
<body class="crt">

<div class="game-wrapper" id="main-container">
    <div id="flash-overlay" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-[120]"></div>

    <!-- 1. 任務選擇 -->
    <div id="mission-screen" class="overlay-screen">
        <h1 class="text-md mb-6 text-red-600 tracking-tighter">VOICE OF THE DEAD</h1>
        <div class="bg-black p-4 border border-zinc-800 w-full max-w-sm">
            <p class="text-[7px] text-zinc-600 mb-2 uppercase text-left">Data Volume</p>
            <div class="grid grid-cols-5 gap-1 mb-4" id="book-grid"></div>
            <p class="text-[7px] text-zinc-600 mb-2 uppercase text-left">Sector Unit</p>
            <div class="grid grid-cols-3 gap-1 mb-4" id="lesson-grid"></div>
            <div id="mission-status" class="text-[7px] text-zinc-500 mb-4 h-4 uppercase">Archive Standby</div>
            <button onclick="confirmMission()" id="confirm-mission-btn" class="btn w-full py-4 text-white bg-blue-900 border-blue-500" disabled>ENTER SECTOR</button>
        </div>
    </div>

    <!-- 2. 登錄與難度 -->
    <div id="login-screen" class="overlay-screen hidden">
        <h2 id="selected-mission-title" class="text-blue-500 mb-4 text-[10px] uppercase">MISSION ID</h2>
        <div class="bg-black p-4 border border-zinc-800 w-full max-w-sm space-y-4">
            <div class="flex gap-1">
                <select id="select-grade" class="bg-black border border-zinc-700 p-2 text-[8px] w-1/2">
                    <option value="G10">10</option><option value="G11">11</option><option value="G12">12</option>
                </select>
                <select id="select-class" class="bg-black border border-zinc-700 p-2 text-[8px] w-1/2">
                    <option value="知足">知足</option><option value="感恩">感恩</option><option value="善解">善解</option><option value="包容">包容</option>
                </select>
            </div>
            <input type="number" id="input-no" placeholder="NUMBER" class="bg-black border border-zinc-700 p-3 w-full text-green-500 text-[10px]">
            <input type="text" id="input-name" placeholder="NAME" class="bg-black border border-zinc-700 p-3 w-full text-green-500 text-[10px]">
            <p class="text-[7px] text-zinc-600 uppercase text-left">Difficulty Level</p>
            <div class="grid grid-cols-2 gap-1">
                <button onclick="setDifficulty(0.7, 'Rookie')" class="btn diff-btn" id="diff-rookie">Rookie</button>
                <button onclick="setDifficulty(1.0, 'Veteran')" class="btn diff-btn active-diff" id="diff-veteran">Veteran</button>
                <button onclick="setDifficulty(1.5, 'Nightmare')" class="btn diff-btn" id="diff-nightmare">Nightmare</button>
                <button onclick="setDifficulty(2.5, 'NoHope')" class="btn diff-btn text-red-600" id="diff-nohope">NO HOPE</button>
            </div>
            <div class="flex gap-2">
                <button onclick="backToMission()" class="btn w-1/3 text-[7px]">BACK</button>
                <button id="start-btn" onclick="handleAuth()" class="btn w-2/3 py-4 bg-red-900 text-white">INITIATE</button>
            </div>
        </div>
    </div>

    <!-- 3. 管理員終端 -->
    <div id="admin-screen" class="overlay-screen hidden">
        <h2 class="text-blue-600 mb-2">ARCHIVE TERMINAL</h2>
        <div class="admin-table-container">
            <table class="w-full text-left">
                <thead class="bg-zinc-900 sticky top-0">
                    <tr><th class="p-1">CLS</th><th class="p-1">NO</th><th class="p-1">NAME</th><th class="p-1">SCR</th><th class="p-1">DIF</th></tr>
                </thead>
                <tbody id="records-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" class="btn mt-4 px-6 py-2">LOGOUT</button>
    </div>

    <!-- BOSS UI -->
    <div id="boss-ui" class="z-[150] px-4 w-full">
        <div class="w-full bg-zinc-900 h-2 border border-white mb-2 overflow-hidden">
            <div id="boss-hp-bar" class="h-full bg-red-600 transition-all duration-300" style="width: 100%"></div>
        </div>
        <div id="boss-sentence" class="flex flex-wrap justify-center gap-2 text-[9px] bg-black/80 p-3 border border-zinc-700"></div>
    </div>

    <!-- 勝利畫面 -->
    <div id="win-screen" class="overlay-screen hidden">
        <h1 class="text-green-500 text-xl mb-4 flicker">MISSION COMPLETE</h1>
        <p class="text-zinc-500 text-[10px] mb-2 uppercase">Final Score</p>
        <p id="win-score-display" class="text-yellow-500 text-3xl mb-8">0</p>
        <button onclick="location.reload()" class="btn px-10 py-4 uppercase">Return Base</button>
    </div>

    <!-- 死亡畫面 -->
    <div id="game-over-screen" class="overlay-screen hidden">
        <h1 class="text-red-700 text-xl mb-6 flicker uppercase">You are dead</h1>
        <p class="text-zinc-500 text-[10px] mb-2 uppercase">Final Score</p>
        <p id="fail-score-display" class="text-yellow-500 text-3xl mb-10">0</p>
        <button onclick="location.reload()" class="btn px-10 py-4 uppercase">Retry Mission</button>
    </div>

    <div class="canvas-container" id="canvas-holder">
        <canvas id="game-canvas"></canvas>
    </div>

    <div class="ui-panel">
        <div class="flex justify-between items-center border-b border-zinc-800 pb-2">
            <div>
                <div id="status-label" class="text-green-500 text-[10px]">FINE</div>
                <div id="score-display" class="text-[8px] text-zinc-600 mt-1">000000</div>
            </div>
            <div id="combo-display" class="text-yellow-500 text-[10px] opacity-0">0 COMBO</div>
        </div>
        <div id="current-word-ui" class="flex items-center justify-center text-[10px] text-center text-zinc-400 px-4">
            AWAITING SIGNAL...
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="togglePause()" class="btn py-3 uppercase">Pause</button>
            <button onclick="location.reload()" class="btn py-3 uppercase">Retreat</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKiz17S_mjAEcat-oT0EDVnvKxhTzxQe8",
        authDomain: "voiceofthedead.firebaseapp.com",
        projectId: "voiceofthedead",
        storageBucket: "voiceofthedead.firebasestorage.app",
        messagingSenderId: "757378314086",
        appId: "1:757378314086:web:aa598f79e28e3cb6a122a7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.fbase = { db, setDoc, doc, collection, getDocs, serverTimestamp, appId: 'voice-reborn-101' };
    signInAnonymously(auth);
</script>

<script>
    const ADMIN_KEY = "AdaWong";
    let state = {
        score: 0, hp: 5, gameActive: false, isPaused: false,
        level: 1, kills: 0, combo: 0,
        difficulty: 1.0, difficultyMode: 'Veteran',
        bossesDefeated: 0,
        enemies: [], particles: [],
        shake: 0, bossMode: false, bossData: null, bossWordIndex: 0,
        spawnTimer: 0, player: { name: "", no: "", class: "" }
    };

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let currentBookData = {};
    let selectedBook = 4;
    let selectedLesson = 1;
    let wakeLock = null;

    function initUI() {
        document.getElementById('book-grid').innerHTML = [1,2,3,4,5].map(i => 
            `<button onclick="selectBook(${i})" class="btn book-btn ${i===4?'active-diff':''}" id="b${i}">${['I','II','III','IV','V'][i-1]}</button>`).join('');
        document.getElementById('lesson-grid').innerHTML = [1,2,3,4,5,6,7,8,9].map(i => 
            `<button onclick="selectLesson(${i})" class="btn lesson-btn ${i===1?'active-diff':''}" id="l${i}">${i}</button>`).join('');
    }
    initUI();

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }

    async function loadBookData(n) {
        selectedBook = n;
        const status = document.getElementById('mission-status');
        status.innerText = `ACCESSING ARCHIVE ${n}...`;
        try {
            const res = await fetch(`book${n}.json`);
            currentBookData = await res.json();
            status.innerText = `SECTOR ${n} READY`;
            checkMissionValid();
        } catch(e) { status.innerText = `ACCESS DENIED`; }
    }
    window.selectBook = (n) => {
        document.querySelectorAll('.book-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`b${n}`).classList.add('active-diff');
        loadBookData(n);
    };
    window.selectLesson = (n) => {
        selectedLesson = n;
        document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`l${n}`).classList.add('active-diff');
        checkMissionValid();
    };
    function checkMissionValid() {
        const btn = document.getElementById('confirm-mission-btn');
        const data = currentBookData[`L${selectedLesson}`];
        if (data) {
            btn.disabled = false;
            document.getElementById('mission-status').innerText = `TARGET: ${data.title.toUpperCase()}`;
        } else { btn.disabled = true; }
    }
    loadBookData(4);

    window.confirmMission = () => {
        document.getElementById('mission-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('selected-mission-title').innerText = currentBookData[`L${selectedLesson}`].title;
    };
    window.backToMission = () => {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('mission-screen').classList.remove('hidden');
    };

    window.handleAuth = async () => {
        const nameInput = document.getElementById('input-name').value;
        if(nameInput === ADMIN_KEY) return showAdmin();
        const no = document.getElementById('input-no').value;
        if(!nameInput || !no) return;
        state.player = { name: nameInput, no, class: document.getElementById('select-grade').value + document.getElementById('select-class').value };
        document.getElementById('login-screen').classList.add('hidden');
        startGame();
    };

    async function showAdmin() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-screen').classList.remove('hidden');
        const body = document.getElementById('records-body');
        body.innerHTML = "<tr><td colspan='5' class='p-4 text-center'>ACCESSING...</td></tr>";
        try {
            const { db, appId, collection, getDocs } = window.fbase;
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
            let res = []; snap.forEach(d => res.push(d.data()));
            res.sort((a,b) => a.class.localeCompare(b.class) || a.no - b.no);
            body.innerHTML = res.map(d => `<tr><td class="p-1 text-blue-400">${d.class}</td><td class="p-1">${d.no}</td><td class="p-1 text-zinc-200">${d.name}</td><td class="p-1 text-green-500">${d.score}</td><td class="p-1 text-[6px]">${d.difficulty || 'V'}</td></tr>`).join('');
        } catch(e) { body.innerHTML = "SYSTEM ERROR"; }
    }

    window.setDifficulty = (val, mode) => {
        state.difficulty = val; state.difficultyMode = mode;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active-diff'));
        document.getElementById(`diff-${mode.toLowerCase()}`).classList.add('active-diff');
    };

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 8; this.vy = (Math.random() - 0.5) * 8;
            this.alpha = 1; this.size = Math.random() * 3 + 1;
        }
        update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.03; return this.alpha > 0; }
        draw(ctx) { ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
    }

    class Enemy {
        constructor(word, isBoss = false) {
            this.word = word; this.isBoss = isBoss; this.z = 0;
            this.x = (Math.random() - 0.5) * 380; this.y = (Math.random() - 0.5) * 80;
            this.speed = (0.0008 + Math.random() * 0.0007) * state.difficulty;
            this.isDying = false; this.opacity = 1; this.wobbleSeed = Math.random() * 100;
        }
        update() {
            if (this.isDying) { this.opacity -= 0.15; return this.opacity <= 0; }
            if (!state.bossMode) this.z += this.speed;
            return this.z >= 1;
        }
        draw(ctx, w, h, isClosest) {
            const scale = this.isBoss ? 2.8 : 1.0;
            const size = (12 + Math.pow(this.z, 2) * 320) * scale;
            const wobbleX = Math.sin(Date.now() * 0.005 + this.wobbleSeed) * 8 * this.z;
            const wobbleY = Math.cos(Date.now() * 0.007 + this.wobbleSeed) * 4 * this.z;
            const screenX = w/2 + (this.x * this.z) + wobbleX;
            const screenY = h/2 + (this.y * this.z) + (this.z * h * 0.45) + wobbleY;

            ctx.save(); ctx.globalAlpha = this.opacity; ctx.translate(screenX, screenY);
            const b = 25 + (this.z * 75);
            ctx.fillStyle = `rgb(${b}, ${b+15}, ${b})`;
            ctx.fillRect(-size/3, -size/2, size/1.5, size/1.5);
            ctx.fillStyle = `rgb(${b+30}, ${b-10}, ${b-10})`;
            ctx.fillRect(-size/6, -size*0.9, size/3, size/3);

            if (isClosest && !this.isBoss) {
                ctx.strokeStyle = '#f00'; ctx.lineWidth = 2;
                ctx.strokeRect(-size/2 - 5, -size - 5, size + 10, size + 10);
            }
            if (!this.isBoss) {
                ctx.font = `${Math.max(7, size/7)}px 'Press Start 2P'`;
                ctx.fillStyle = isClosest ? '#fff' : '#666'; ctx.textAlign = 'center';
                ctx.fillText(this.word.toUpperCase(), 0, -size * 1.1);
            }
            ctx.restore();
        }
    }

    function startGame() {
        state.gameActive = true; state.hp = 5; state.score = 0; state.kills = 0; state.bossesDefeated = 0;
        state.enemies = []; state.particles = [];
        requestWakeLock(); handleResize(); initSpeech(); requestAnimationFrame(gameLoop);
    }
    function handleResize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
    }

    let recognition;
    function initSpeech() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) return;
        recognition = new Speech();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'en-US';
        recognition.onresult = (e) => {
            let transcript = "";
            for (let i = e.resultIndex; i < e.results.length; i++) transcript += e.results[i][0].transcript.toLowerCase();
            processCommand(transcript);
        };
        recognition.onend = () => { if(state.gameActive && !state.isPaused) try { recognition.start(); } catch(e){} };
        recognition.start();
    }

    function processCommand(text) {
        const clean = (s) => s.replace(/[.,!?]/g, "").trim();
        const input = clean(text);
        if (state.bossMode) {
            if (input.includes(clean(state.bossData.words[state.bossWordIndex].toLowerCase()))) hitBoss();
        } else {
            const closest = [...state.enemies].filter(e => !e.isDying).sort((a,b) => b.z - a.z)[0];
            if (closest && input.includes(clean(closest.word.toLowerCase()))) killEnemy(state.enemies.indexOf(closest));
        }
    }

    function killEnemy(idx) {
        const en = state.enemies[idx]; en.isDying = true;
        state.score += 100; state.kills++; state.combo++;
        createExplosion(en); state.shake = 12;
        
        let trigger = false;
        if(state.difficultyMode==='Rookie' && state.kills>=10) trigger=true;
        else if(state.difficultyMode==='Veteran' && state.kills>=15) trigger=true;
        else if(state.difficultyMode==='Nightmare' && state.kills>=15) trigger=true;
        else if(state.difficultyMode==='NoHope' && state.kills>=10) trigger=true;
        if(trigger) startBossBattle();
    }

    function startBossBattle() {
        state.bossMode = true; state.enemies = [new Enemy("BOSS", true)]; state.enemies[0].z = 0.5;
        const sents = currentBookData[`L${selectedLesson}`].stages["2"];
        const full = sents[Math.floor(Math.random() * sents.length)];
        state.bossData = { full, words: full.split(' ') }; state.bossWordIndex = 0;
        document.getElementById('boss-ui').style.opacity = '1';
        const container = document.getElementById('boss-sentence');
        container.innerHTML = state.bossData.words.map((w, i) => `<span id="bw-${i}">${w}</span>`).join(' ');
        updateBossUI();
    }

    function updateBossUI() {
        state.bossData.words.forEach((_, i) => {
            const el = document.getElementById(`bw-${i}`);
            el.className = i < state.bossWordIndex ? 'text-zinc-600 line-through' : (i === state.bossWordIndex ? 'boss-word-active' : 'text-white');
        });
        document.getElementById('boss-hp-bar').style.width = (100 - (state.bossWordIndex/state.bossData.words.length*100)) + '%';
    }

    function hitBoss() {
        state.bossWordIndex++; state.shake = 18; createExplosion(state.enemies[0]);
        if (state.bossWordIndex >= state.bossData.words.length) {
            state.enemies[0].isDying = true; state.bossesDefeated++;
            setTimeout(() => {
                let win = false; let next = false;
                if(state.difficultyMode==='Rookie'||state.difficultyMode==='Veteran') win=true;
                else if(state.difficultyMode==='Nightmare') { if(state.bossesDefeated<2) next=true; else win=true; }
                else if(state.difficultyMode==='NoHope') { if(state.bossesDefeated<3) { state.kills=0; state.bossMode=false; document.getElementById('boss-ui').style.opacity='0'; } else win=true; }
                if(next) startBossBattle(); else if(win) winGame();
            }, 800);
        } else updateBossUI();
    }

    function createExplosion(en) {
        const rect = canvas.parentElement.getBoundingClientRect();
        const x = rect.width/2 + (en.x * en.z);
        const y = rect.height/2 + (en.y * en.z) + (en.z * rect.height * 0.45);
        for(let i=0; i<12; i++) state.particles.push(new Particle(x, y, '#5a5'));
    }

    function triggerDamage() {
        state.hp--; state.shake = 35; state.combo = 0;
        document.getElementById('main-container').classList.add('glitch-active');
        setTimeout(() => document.getElementById('main-container').classList.remove('glitch-active'), 400);
        if (state.hp <= 0) endGame();
    }

    function gameLoop() {
        if (!state.gameActive || state.isPaused) return;
        const rect = canvas.parentElement.getBoundingClientRect();
        const w = rect.width; const h = rect.height;
        ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, w, h);
        
        if (state.shake > 0) { ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake); state.shake *= 0.85; }

        if (!state.bossMode && Date.now() - state.spawnTimer > 2000/state.difficulty) {
            const list = currentBookData[`L${selectedLesson}`].stages["1"];
            state.enemies.push(new Enemy(list[Math.floor(Math.random()*list.length)]));
            state.spawnTimer = Date.now();
        }

        const closest = [...state.enemies].filter(e => !e.isDying).sort((a,b) => b.z - a.z)[0];
        for (let i = state.enemies.length - 1; i >= 0; i--) {
            const en = state.enemies[i];
            if (en.update()) {
                if (!en.isDying) { triggerDamage(); state.enemies.splice(i, 1); }
                else state.enemies.splice(i, 1);
            } else en.draw(ctx, w, h, en === closest);
        }
        for (let i = state.particles.length - 1; i >= 0; i--) {
            if (!state.particles[i].update()) state.particles.splice(i, 1);
            else state.particles[i].draw(ctx);
        }

        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        updateUIPanel();
        requestAnimationFrame(gameLoop);
    }

    function updateUIPanel() {
        document.getElementById('score-display').innerText = state.score.toString().padStart(6, '0');
        const comboEl = document.getElementById('combo-display');
        comboEl.style.opacity = state.combo > 1 ? '1' : '0'; comboEl.innerText = `${state.combo} COMBO`;
        const status = document.getElementById('status-label');
        if (state.hp > 3) { status.innerText = 'FINE'; status.className = 'text-green-500 text-[10px]'; }
        else if (state.hp > 1) { status.innerText = 'CAUTION'; status.className = 'text-yellow-500 text-[10px]'; }
        else { status.innerText = 'DANGER'; status.className = 'text-red-600 text-[10px]'; }

        const target = [...state.enemies].filter(e => !e.isDying).sort((a,b) => b.z - a.z)[0];
        let t = "AWAITING...";
        if (state.bossMode) t = `BOSS STAGE (${state.bossesDefeated+1})`;
        else if (target) t = target.word.toUpperCase();
        document.getElementById('current-word-ui').innerText = t;
    }

    async function syncData() {
        try {
            const { db, appId, setDoc, doc, serverTimestamp } = window.fbase;
            const rid = `${state.player.class}_${state.player.no}_${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', rid), {
                ...state.player, score: state.score, difficulty: state.difficultyMode, timestamp: serverTimestamp()
            });
        } catch(e){}
    }

    function winGame() { 
        state.gameActive = false; 
        if(wakeLock) wakeLock.release(); 
        document.getElementById('win-score-display').innerText = state.score;
        document.getElementById('win-screen').classList.remove('hidden'); 
        syncData(); 
    }
    function endGame() { 
        state.gameActive = false; 
        if(wakeLock) wakeLock.release(); 
        document.getElementById('fail-score-display').innerText = state.score;
        document.getElementById('game-over-screen').classList.remove('hidden'); 
        syncData(); 
    }
    
    window.togglePause = () => { 
        state.isPaused = !state.isPaused; 
        if (!state.isPaused) requestAnimationFrame(gameLoop); 
    };
    window.addEventListener('resize', handleResize);
</script>
</body>
</html>
